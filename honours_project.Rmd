---
title: "Honours Project"
author: "Philo Tchokonte-Nana"
date: '2022-07-26'
output: html_document
---

```{r setup, include=FALSE}
pacman::p_load(pacman, tidyverse, janitor, tidymodels, knitr, missForest)
knitr::opts_chunk$set(echo = TRUE)
```

1. Data Preparation
```{r data}
#import file and clean data
my_file <- "my_dataset.csv"

my_data <- read.csv(my_file, header = TRUE, sep = ",") %>% 
  janitor::clean_names(.) %>%
  rename(., hiv_status = hi_vstatus) %>% #did not name hiv_status properly
  rename(., TB_status = final_class)

my_data <- my_data[,which(!colnames(my_data) %in% c("barcode","timepoint_id"))]
my_data <- my_data %>% filter(TB_status != "Possible")
my_data <- my_data %>% replace_with_na(replace = list(enrolment_age=0, hiv_status=common_na_strings))
my_data$TB_status[my_data$TB_status %in% c("Probable","Definite")] <- "Positive"
my_data$TB_status[my_data$TB_status != "Positive"] <- "Negative"
my_data <- my_data %>% mutate_at(c("study_site","sex","TB_status","hiv_status"), as.factor)
```

2.Analyse the data
```{r plot}
plot_data <- my_data
plot_data[, 7:28] <- scale(plot_data[,7:28], center = FALSE, scale = TRUE)
#plot grouped graphs5
plot_data <- pivot_longer(plot_data, 7:28, names_to = "Biomarkers", values_to = "Observations")

ggplot(plot_data, aes(x=TB_status, y=log10(Observations))) +
  geom_boxplot(outlier.size=0.3) +
  facet_wrap("Biomarkers", ncol = 6) + 
  ylab("log10 Concentration")
```

```{r impute}
#impute missing data
model_data <- missForest(my_data[,-1], ntree=200, decreasing=TRUE)$ximp
```

3. Build model
```{r model}
#split data into training and test sets 
set.seed(1000)
  # This function can stratify on multiple variables
  #70% of the data in the training set
stratified <- stratified(model_data, c('study_site','TB_status','sex','hiv_status'), 0.7, keep.rownames=TRUE)
  # No we create the tidymodels split data object
sample_data <- initial_split(model_data, prop=0.7, strata = TB_status)
  # replace the training set id's with those selected by splitstackshape
sample_data$in_id <- as.integer(stratified$rn)
  #create data frames for the two sets
train_data <- training(sample_data) 
test_data <- testing(sample_data)


#create recipe and roles
data_rec <- recipe(TB_status ~., data = train_data) %>%
    #keep the variables listed but do not use them as either outcomes or predictors
  update_role(study_site, sex, enrolment_age, new_role = "ID")


#fit a model with a recipe and tune hyperparameters
rf_mod <- decision_tpred_Negativeree(cost_complexity = tune(), tree_depth = tune()) %>%
    #engine to fit model
  set_engine("rpart") %>% 
    #predicts the type of outcome: qualitative
  set_mode("classification") 

rf_grid <- grid_regular(cost_complexity(), tree_depth(), levels = 5)

folds <- vfold_cv(train_data)

  #model workflow
rf_workflow <- workflow() %>% add_model(rf_mod) %>% add_recipe(data_rec)

rf_workflow
  #tuning results
rf_res <- rf_workflow %>% tune_grid(resamples = folds, grid = rf_grid)
  #visualize the best top 5 results
best_tree <- rf_res %>% select_best("accuracy")

final_workflow <- rf_workflow %>% finalize_workflow(best_tree)

rf_fit <- final_workflow %>% 
    #this function fits the finalized model on the full training data set and 
    #evaluates the finalized model on the testing data.
  last_fit(sample_data)

final_tree <- extract_workflow(rf_fit)
```

4.Assess performance
```{r performance}
#training data performance


#model performance
rf_fit %>% collect_metrics()

rf_fit %>% collect_predictions() %>% 
  roc_curve(TB_status, .pred_Negative) %>%
  autoplot()
```
