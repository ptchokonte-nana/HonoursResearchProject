---
title: "Honours Project"
author: "Philo Tchokonte-Nana"
date: '2022-07-26'
output: html_document
---

```{r setup, include=FALSE}
pacman::p_load(pacman, tidyverse, janitor, tidymodels, knitr, missForest)
knitr::opts_chunk$set(echo = TRUE)
```

## Data Preparation
```{r data}
#import file and clean data
my_file <- "my_dataset.csv"
my_data <- read.csv(my_file, header = TRUE, sep = ",") %>% 
  janitor::clean_names(.) %>%
  rename(., hiv_status = hi_vstatus) %>% #did not name hiv_status properly
  rename(., TB_status = final_class)
my_data <- my_data[,which(!colnames(my_data) %in% c("barcode","timepoint_id"))]
my_data <- my_data %>% filter(TB_status != "Possible")
my_data <- my_data %>% replace_with_na(replace = list(enrolment_age=0, hiv_status=common_na_strings))
my_data$TB_status[my_data$TB_status %in% c("Probable","Definite")] <- "Positive"
my_data$TB_status[my_data$TB_status != "Positive"] <- "Negative"
my_data <- my_data %>% mutate_at(c("study_site","sex","TB_status","hiv_status"), as.factor)
```


## Analyse the data
```{r plot}
plot_data <- my_data
plot_data[, 7:28] <- scale(plot_data[,7:28], center = FALSE, scale = TRUE)
#plot grouped graphs5
plot_data <- pivot_longer(plot_data, 7:28, names_to = "Biomarkers", values_to = "Observations")
ggplot(plot_data, aes(x=TB_status, y=log10(Observations))) +
  geom_boxplot(outlier.size=0.3) +
  facet_wrap("Biomarkers", ncol = 6) + 
  ylab("log10 Concentration")
```


## Impute data
```{r impute}
#impute missing data
model_data <- missForest(my_data[,-1], ntree=200, decreasing=TRUE)$ximp
```


## Build model
```{r model}
set.seed(1000)

stratified <- stratified(model_data, c('study_site','TB_status','sex','hiv_status'), 0.7, keep.rownames=TRUE)
sample_data <- initial_split(model_data, prop=0.7, strata = TB_status)
sample_data$in_id <- as.integer(stratified$rn)

train_data <- training(sample_data) 
test_data <- testing(sample_data)

folds <- vfold_cv(train_data)

# recipe ------------------------------------------------------------------

normalised_recipe <- recipe(TB_status ~., data = train_data) %>% 
              update_role(study_site, sex, enrolment_age, new_role = "ID") %>%
              step_normalize(all_numeric_predictors())

all_numeric_recipe <- recipe(TB_status ~., data = train_data) %>% 
              update_role(study_site, sex, enrolment_age, new_role = "ID") %>%
              step_normalize(all_numeric_predictors()) %>%
              step_dummy(all_nominal_predictors())

# models ------------------------------------------------------------------

decision_tree_mod <- 
  decision_tree(cost_complexity = tune(), tree_depth = tune()) %>% 
  set_engine("rpart") %>% 
  set_mode("classification") 
random_Forest_mod <- 
  rand_forest(mtry = tune(), trees = tune(), min_n = tune()) %>% 
  set_engine("ranger") %>% 
  set_mode("classification")
logistic_regression_mod <- 
  logistic_reg(penalty = tune(), mixture = tune()) %>%
  set_engine("glmnet") %>%
  set_mode("classification")

# workflow ----------------------------------------------------------------

normalised_workflow <- 
  workflow_set(
    preproc = list(normalised = normalized_recipe),
    models = list(decision_tree = decision_tree_mod, 
                  random_Forest = random_Forest_mod)) 

all_numeric_workflow <- 
  workflow_set(
    preproc = list(numeric = all_numeric_recipe),
    models = list(logistic_regression = logistic_regression_mod)) 

all_workflow <- bind_rows(normalised_workflow, all_numeric_workflow) %>%
  mutate(wflow_id = gsub("(normalised_)|(numeric_)", "", wflow_id))

# grid --------------------------------------------------------------------

grid_ctrl <- control_grid(save_pred = TRUE, save_workflow = TRUE)
grid_results <- all_workflow %>% workflow_map(resamples = folds, control = grid_ctrl)
grid_results %>% collect_metrics() %>% filter(.metric == "accuracy") %>% 
  select(model, .config, accuracy = mean)

grid_results %>% collect_metrics()

# model fit ---------------------------------------------------------------

```


## Assess performance
```{r performance}
#training data performance

#model performance
```
